<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
		"http://www.mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="loa.backend.mapper.BoardMapper">

	<select id="getAllArticle" resultType="BoardModel">
		select *
		from (
			select board_number,COUNT(*)OVER(PARTITION BY bpi.board_number) as member_count
			from board_party_info bpi) t1 
		join board_info bi on t1.board_number = bi.board_number
		join board_raid_info bri on t1.board_number = bri.board_number 
		join board_party_filter bpf on t1.board_number = bpf.board_number
		group by t1.board_number
		order by t1.board_number desc
	</select>

	<insert id="addArticle1" parameterType="BoardModel">
    	insert into loain.board_info (title, content, user_number, view_cnt, raid_leader, status) value (#{title},#{content},#{user_number},"0",#{raid_leader},"모집중");
    </insert>
    
    <insert id="addArticle2" parameterType="BoardModel">
    	insert into loain.board_party_filter (board_number, proficiency, card_level, minLevel) value (#{board_number},#{proficiency},#{card_level},"0");
    </insert>
    
    <insert id="addArticle3" parameterType="BoardModel">
    	insert into loain.board_party_info (board_number, party_member) value (#{board_number},#{party_member});
    </insert>
    
    <insert id="addArticle4" parameterType="BoardModel">
    	insert into loain.board_raid_info (board_number, raid_type, raid_difficulty, minGate, maxGate, startDate) value (#{board_number},#{raid_type},#{raid_difficulty},#{minGate},#{maxGate},#{startDate});
    </insert>
    
    <select id="checkBoardNum" resultType="BoardModel">
    	select board_number from loain.board_info order by board_number desc limit 1
    </select>
    
    <select id="getRaid" resultType="BoardModel">
		select * 
		FROM board_info bi 
		join board_raid_info bri on bi.board_number = bri.board_number
		join board_party_info bpi on bi.board_number = bpi.board_number
		join board_party_filter bpf on bi.board_number = bpf.board_number 
		join character_info ci on ci.character_name = bpi.party_member
		where ci.user_number  = #{user_number}
		order by bi.board_number 
	</select>
	
	<delete id="deleteArticle">
		delete from 
		board_info, board_party_filter, board_party_info, board_raid_info
		Using board_info
		left join board_party_filter on board_info.board_number = board_party_filter.board_number
		left join board_party_info on board_info.board_number = board_party_info.board_number
		left join board_raid_info on board_info.board_number = board_raid_info.board_number
		where board_info.board_number = #{board_number}
	</delete>
</mapper>